<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self';">
    <title>Zon Amazon Vendor Audit Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjOBaZBOA87z+IhZE9DA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js" integrity="sha512-SGWgwwRA8xZgEoKiex3UubkSkV1zSE1BS6O4pXcaxcNtUlQsOmOmhVnDwIvqGRfEmuz83tIGL13cXMZn6upPyg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==" crossorigin="anonymous"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #228B22 0%, #006400 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            padding: 20px 0;
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .upload-section h2 {
            margin-bottom: 20px;
            color: #444;
            text-align: center;
        }

        .note {
            background: #e8f4f8;
            border-left: 4px solid #228B22;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
            color: #555;
        }

        .file-upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #228B22;
            background: #f8f9ff;
        }

        .file-upload.active {
            border-color: #228B22;
            background: #f0f4ff;
        }

        .file-upload.error {
            border-color: #e74c3c;
            background: #ffeaea;
        }

        .file-upload.success {
            border-color: #27AE60;
            background: #eafaf1;
        }

        .file-upload input {
            display: none;
        }

        .file-upload label {
            cursor: pointer;
            font-weight: 600;
            color: #666;
            display: block;
        }

        .file-status {
            margin-top: 10px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .file-status.success {
            color: #27AE60;
        }

        .file-status.error {
            color: #e74c3c;
        }

        .process-btn {
            background: linear-gradient(135deg, #228B22 0%, #006400 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 20px auto;
        }

        .process-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(34, 139, 34, 0.4);
        }

        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #ffeaea;
            border: 1px solid #e74c3c;
            color: #c0392b;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .success-message {
            background: #eafaf1;
            border: 1px solid #27ae60;
            color: #1e8449;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 2px solid #666;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .dashboard {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .dashboard.show {
            display: grid;
        }

        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .metric-card h3 {
            color: #444;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #228B22;
            margin-bottom: 10px;
        }

        .metric-change {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .metric-change.positive {
            color: #27AE60;
        }

        .metric-change.negative {
            color: #E74C3C;
        }

        .metric-change.neutral {
            color: #7F8C8D;
        }

        .chart-container {
            grid-column: span 2;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: 400px;
        }

        .chart-container canvas {
            max-height: 320px !important;
        }

        .data-table {
            grid-column: span 3;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .summary-section {
            grid-column: span 3;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .summary-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #228B22;
        }

        .summary-card h4 {
            color: #444;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .summary-list {
            list-style: none;
            padding: 0;
        }

        .summary-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .summary-list li:last-child {
            border-bottom: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #444;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .export-section {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        .export-section.show {
            display: block;
        }

        .export-btn {
            background: #27AE60;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            margin: 0 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #219A52;
            transform: translateY(-2px);
        }

        .version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .chart-container,
            .data-table,
            .summary-section {
                grid-column: span 1;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .metric-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Zon Amazon Vendor Audit</h1>
            <p>Analytics dashboard for publisher performance optimisation</p>
        </div>

        <div class="upload-section">
            <h2>Upload Your Excel Reports</h2>
            <div class="note">
                <strong>Note:</strong> Upload your Amazon Vendor Central Excel files below. Supports files up to 50MB.
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <div class="file-upload-grid">
                <div class="file-upload" id="salesUpload">
                    <input type="file" id="salesFile" accept=".xlsx,.xls,.csv" />
                    <label for="salesFile">
                        üìä Upload Sales Report<br>
                        <small>Sales_ASIN_Manufacturing_Retail_*.xlsx</small>
                    </label>
                    <div class="file-status" id="salesStatus"></div>
                </div>
                <div class="file-upload" id="trafficUpload">
                    <input type="file" id="trafficFile" accept=".xlsx,.xls,.csv" />
                    <label for="trafficFile">
                        üö¶ Upload Traffic Report<br>
                        <small>Traffic_ASIN_*.xlsx</small>
                    </label>
                    <div class="file-status" id="trafficStatus"></div>
                </div>
                <div class="file-upload" id="inventoryUpload">
                    <input type="file" id="inventoryFile" accept=".xlsx,.xls,.csv" />
                    <label for="inventoryFile">
                        üì¶ Upload Inventory Report<br>
                        <small>Inventory_ASIN_Manufacturing_Retail_*.xlsx</small>
                    </label>
                    <div class="file-status" id="inventoryStatus"></div>
                </div>
            </div>
            <button class="process-btn" id="processBtn" disabled>Process Data & Generate Dashboard</button>
        </div>

        <div id="loading" class="loading">
            Processing your data...<span class="loading-spinner"></span>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="metric-card">
                <h3>Ordered Units</h3>
                <div class="metric-value" id="orderedUnits">0</div>
                <div class="metric-change" id="orderedUnitsChange"></div>
            </div>

            <div class="metric-card">
                <h3>Ordered Revenue</h3>
                <div class="metric-value" id="orderedRevenue">¬£0</div>
                <div class="metric-change" id="orderedRevenueChange"></div>
            </div>

            <div class="metric-card">
                <h3>Featured Page Views</h3>
                <div class="metric-value" id="pageViews">0</div>
                <div class="metric-change" id="pageViewsChange"></div>
            </div>

            <div class="metric-card">
                <h3>Conversion Rate</h3>
                <div class="metric-value" id="conversionRate">0%</div>
                <div class="metric-change" id="conversionRateChange"></div>
            </div>

            <div class="metric-card">
                <h3>Daily Sales</h3>
                <div class="metric-value" id="dailySales">¬£0</div>
                <div class="metric-change" id="dailySalesChange"></div>
            </div>

            <div class="metric-card">
                <h3>Net PPM %</h3>
                <div class="metric-value" id="netPPM">0%</div>
                <div class="metric-change" id="netPPMChange"></div>
            </div>

            <div class="metric-card">
                <h3>Vendor Lead Time</h3>
                <div class="metric-value" id="vendorLeadTime">0 days</div>
                <div class="metric-change" id="vendorLeadTimeChange"></div>
            </div>

            <div class="metric-card">
                <h3>Shipped Units</h3>
                <div class="metric-value" id="shippedUnits">0</div>
                <div class="metric-change" id="shippedUnitsChange"></div>
            </div>

            <div class="metric-card">
                <h3>90+ Days Inventory %</h3>
                <div class="metric-value" id="aged90Percent">0%</div>
                <div class="metric-change" id="aged90PercentChange"></div>
            </div>

            <div class="chart-container">
                <h3>Revenue Trend</h3>
                <canvas id="revenueChart"></canvas>
            </div>

            <div class="chart-container">
                <h3>Top Products by Revenue</h3>
                <canvas id="productsChart"></canvas>
            </div>

            <div class="summary-section">
                <h3>Performance Insights</h3>
                <div class="summary-grid">
                    <div class="summary-card">
                        <h4>üèÜ Top Converting Products</h4>
                        <p>Products performing 15%+ above average conversion rate</p>
                        <ul class="summary-list" id="topConvertingList"></ul>
                    </div>
                    <div class="summary-card">
                        <h4>üí∞ Revenue Recovery Opportunities</h4>
                        <p>High-revenue products (¬£1k+) with below-average conversion and significant traffic</p>
                        <ul class="summary-list" id="revenueRecoveryList"></ul>
                    </div>
                    <div class="summary-card">
                        <h4>üìà Top Revenue Products</h4>
                        <p>Highest performing products by revenue</p>
                        <ul class="summary-list" id="topRevenueList"></ul>
                    </div>
                </div>
            </div>

            <div class="data-table">
                <h3>Product Performance Summary</h3>
                <div style="overflow-x: auto;">
                    <table id="performanceTable">
                        <thead>
                            <tr>
                                <th>ASIN</th>
                                <th>Product Title</th>
                                <th>Ordered Units</th>
                                <th>Ordered Revenue</th>
                                <th>Page Views</th>
                                <th>Conversion Rate</th>
                                <th>Daily Sales</th>
                                <th>Shipped Units</th>
                                <th>90+ Days Inventory %</th>
                                <th>Lead Time (days)</th>
                                <th>Net PPM %</th>
                            </tr>
                        </thead>
                        <tbody id="performanceTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="export-section" id="exportSection">
            <h3>Export Your Report</h3>
            <button class="export-btn" id="exportExcel">üìä Export to Excel</button>
            <button class="export-btn" id="exportCSV">üìã Export to CSV</button>
            <button class="export-btn" id="exportPDF">üìÑ Export to PDF</button>
        </div>

        <div class="version-info">
            v1.01 | Zon Analytics
        </div>
    </div>

    <script>
        class VendorDashboard {
            constructor() {
                this.salesData = [];
                this.trafficData = [];
                this.inventoryData = [];
                this.processedData = [];
                this.charts = {};
                this.daysInMonth = 31;
                this.maxFileSize = 50 * 1024 * 1024;
                this.init();
            }

            init() {
                try {
                    this.bindEvents();
                    console.log('Dashboard initialized');
                } catch (error) {
                    console.error('Init failed:', error);
                    this.showError('Failed to initialize dashboard');
                }
            }

            bindEvents() {
                const salesFile = document.getElementById('salesFile');
                const trafficFile = document.getElementById('trafficFile');
                const inventoryFile = document.getElementById('inventoryFile');
                const processBtn = document.getElementById('processBtn');

                salesFile.addEventListener('change', (e) => this.handleFile(e, 'sales'));
                trafficFile.addEventListener('change', (e) => this.handleFile(e, 'traffic'));
                inventoryFile.addEventListener('change', (e) => this.handleFile(e, 'inventory'));
                processBtn.addEventListener('click', () => this.processData());
            }

            bindExportEvents() {
                const exportExcel = document.getElementById('exportExcel');
                const exportCSV = document.getElementById('exportCSV');
                
                if (exportExcel) exportExcel.addEventListener('click', () => this.exportExcel());
                if (exportCSV) exportCSV.addEventListener('click', () => this.exportCSV());
            }

            showError(msg) {
                const div = document.getElementById('errorMessage');
                if (div) {
                    div.textContent = msg;
                    div.style.display = 'block';
                    setTimeout(() => div.style.display = 'none', 5000);
                }
            }

            showSuccess(msg) {
                const div = document.getElementById('successMessage');
                if (div) {
                    div.textContent = msg;
                    div.style.display = 'block';
                    setTimeout(() => div.style.display = 'none', 3000);
                }
            }

            updateFileStatus(type, status, msg) {
                const statusDiv = document.getElementById(type + 'Status');
                const uploadDiv = document.getElementById(type + 'Upload');
                
                if (statusDiv) {
                    statusDiv.textContent = msg;
                    statusDiv.className = 'file-status ' + status;
                }
                if (uploadDiv) {
                    uploadDiv.className = 'file-upload ' + status;
                }
            }

            validateFile(file) {
                if (!file) throw new Error('No file selected');
                if (file.size > this.maxFileSize) {
                    throw new Error('File too large');
                }
                return true;
            }

            handleFile(event, type) {
                const file = event.target.files[0];
                
                try {
                    this.validateFile(file);
                    this.updateFileStatus(type, 'active', 'Processing...');
                    
                    if (file.name.match(/\.(xlsx|xls)$/i)) {
                        this.processExcel(file, type);
                    } else {
                        this.processCSV(file, type);
                    }
                } catch (error) {
                    this.updateFileStatus(type, 'error', error.message);
                    this.showError('Error: ' + error.message);
                }
            }

            processExcel(file, type) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
                        
                        if (jsonData.length < 2) {
                            throw new Error('File appears empty');
                        }

                        const headers = jsonData[0];
                        const rows = jsonData.slice(1);
                        
                        this[type + 'Data'] = rows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[String(header).trim()] = row[index] || '';
                            });
                            return obj;
                        }).filter(row => Object.values(row).some(val => val !== ''));

                        this.updateFileStatus(type, 'success', '‚úÖ Loaded ' + this[type + 'Data'].length + ' rows');
                        this.checkReady();
                    } catch (error) {
                        this.updateFileStatus(type, 'error', error.message);
                        this.showError('Excel error: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            processCSV(file, type) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const parsed = Papa.parse(csv, {
                            header: true,
                            skipEmptyLines: true
                        });

                        this[type + 'Data'] = parsed.data.filter(row => 
                            Object.values(row).some(val => val !== null && val !== '')
                        );

                        this.updateFileStatus(type, 'success', '‚úÖ Loaded ' + this[type + 'Data'].length + ' rows');
                        this.checkReady();
                    } catch (error) {
                        this.updateFileStatus(type, 'error', error.message);
                        this.showError('CSV error: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            checkReady() {
                const ready = this.salesData.length > 0 && 
                             this.trafficData.length > 0 && 
                             this.inventoryData.length > 0;
                
                const btn = document.getElementById('processBtn');
                if (btn) btn.disabled = !ready;
                
                if (ready) {
                    this.showSuccess('Ready to process!');
                }
            }

            processData() {
                const loading = document.getElementById('loading');
                const dashboard = document.getElementById('dashboard');
                const exportSection = document.getElementById('exportSection');

                if (loading) loading.style.display = 'block';
                if (dashboard) dashboard.classList.remove('show');
                if (exportSection) exportSection.classList.remove('show');
                
                setTimeout(() => {
                    try {
                        this.processedData = this.mergeData();
                        
                        if (this.processedData.length === 0) {
                            throw new Error('No data to process');
                        }

                        this.updateDashboard();
                        this.createCharts();
                        this.populateTable();
                        this.populateInsights();
                        
                        if (loading) loading.style.display = 'none';
                        if (dashboard) dashboard.classList.add('show');
                        if (exportSection) exportSection.classList.add('show');
                        
                        this.bindExportEvents();
                        this.showSuccess('Dashboard ready with ' + this.processedData.length + ' products!');
                    } catch (error) {
                        if (loading) loading.style.display = 'none';
                        this.showError('Processing failed: ' + error.message);
                    }
                }, 100);
            }

            mergeData() {
                const merged = [];
                
                const trafficMap = new Map();
                this.trafficData.forEach(row => {
                    if (row.ASIN) trafficMap.set(String(row.ASIN), row);
                });

                const inventoryMap = new Map();
                this.inventoryData.forEach(row => {
                    if (row.ASIN) inventoryMap.set(String(row.ASIN), row);
                });

                this.salesData.forEach(salesRow => {
                    if (!salesRow.ASIN) return;

                    const asin = String(salesRow.ASIN);
                    const trafficRow = trafficMap.get(asin) || {};
                    const inventoryRow = inventoryMap.get(asin) || {};

                    const orderedUnits = this.parseNum(salesRow['Ordered units']) || 0;
                    const orderedRevenue = this.parseCurrency(salesRow['Ordered revenue']) || 0;
                    const dispatchedRevenue = this.parseCurrency(salesRow['Dispatched revenue']) || 0;
                    const dispatchedCOGS = this.parseCurrency(salesRow['Dispatched COGS']) || 0;
                    const dispatchedUnits = this.parseNum(salesRow['Dispatched units']) || 0;
                    const pageViews = this.parseNum(trafficRow['Featured offer page views']) || 0;
                    const leadTime = this.parseNum(inventoryRow['Overall Vendor Lead Time (days)']) || 0;
                    
                    if (orderedUnits === 0 && orderedRevenue === 0) return;
                    
                    const conversionRate = pageViews > 0 ? (orderedUnits / pageViews) * 100 : 0;
                    const dailySales = orderedRevenue / this.daysInMonth;
                    const netPPM = dispatchedRevenue > 0 ? ((dispatchedRevenue - dispatchedCOGS) / dispatchedRevenue) * 100 : 0;
                    const shipRate = orderedUnits > 0 ? (dispatchedUnits / orderedUnits) * 100 : 0;

                    const orderedRevenueYoY = this.parseYoY(salesRow['Ordered Revenue ‚Äì Same Period Last Year (%)']);
                    const orderedUnitsYoY = this.parseYoY(salesRow['Ordered Units ‚Äì Same Period Last Year (%)']);
                    const pageViewsYoY = this.parseYoY(trafficRow['Featured offer page views ‚Äì Same Period Last Year (%)']);
                    const leadTimeYoY = this.parseYoY(inventoryRow['Overall Vendor Lead Time (days) ‚Äì Same Period Last Year (%)']);

                    merged.push({
                        asin: salesRow.ASIN,
                        productTitle: salesRow['Product title'] || '',
                        brand: salesRow.Brand || '',
                        orderedUnits,
                        orderedRevenue,
                        dispatchedRevenue,
                        dispatchedCOGS,
                        dispatchedUnits,
                        pageViews,
                        conversionRate,
                        dailySales,
                        netPPM,
                        leadTime,
                        aged90Percent,
                        sellableUnits,
                        aged90Units,
                        orderedRevenueYoY,
                        orderedUnitsYoY,
                        pageViewsYoY,
                        leadTimeYoY
                    });
                });

                return merged.sort((a, b) => b.orderedRevenue - a.orderedRevenue);
            }

            parseNum(value) {
                if (!value) return 0;
                return parseInt(String(value).replace(/[,]/g, '')) || 0;
            }

            parseCurrency(value) {
                if (!value) return 0;
                return parseFloat(String(value).replace(/[¬£$,]/g, '')) || 0;
            }

            parseYoY(value) {
                if (!value || value === '' || value === null) return null;
                const num = parseFloat(value);
                if (isNaN(num)) return null;
                
                // FIXED: Amazon provides percentages in different formats
                // Values like -0.1575 = -15.75%, but 16.4304 = 16.43% (already a percentage)
                // If absolute value is ‚â§ 1, it's decimal format, multiply by 100
                // If > 1 but < 100, it's likely already a percentage
                // If ‚â• 100, it's definitely a percentage (like 1643.04% growth)
                
                if (Math.abs(num) <= 1) {
                    return num * 100; // Convert decimal to percentage
                } else if (Math.abs(num) < 100) {
                    return num; // Already a percentage
                } else {
                    return num; // Large percentage values
                }
            }

            formatYoY(value) {
                if (value === null) return 'No data';
                const formatted = value > 0 ? '+' + value.toFixed(1) + '%' : value.toFixed(1) + '%';
                const className = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
                return '<span class="' + className + '">' + formatted + '</span>';
            }

            updateDashboard() {
                const totals = this.calculateTotals();
                
                this.updateElement('orderedUnits', totals.orderedUnits.toLocaleString());
                this.updateElement('orderedRevenue', '¬£' + totals.orderedRevenue.toLocaleString());
                this.updateElement('pageViews', totals.pageViews.toLocaleString());
                this.updateElement('conversionRate', totals.conversionRate.toFixed(2) + '%');
                this.updateElement('dailySales', '¬£' + totals.dailySales.toLocaleString());
                this.updateElement('netPPM', totals.netPPM.toFixed(1) + '%');
                this.updateElement('vendorLeadTime', totals.leadTime.toFixed(1) + ' days');
                this.updateElement('shippedUnits', totals.shippedUnits.toLocaleString());
                this.updateElement('aged90Percent', totals.aged90Percent.toFixed(1) + '%');

                this.updateElementHTML('orderedUnitsChange', this.formatYoY(totals.orderedUnitsYoY));
                this.updateElementHTML('orderedRevenueChange', this.formatYoY(totals.orderedRevenueYoY));
                this.updateElementHTML('pageViewsChange', this.formatYoY(totals.pageViewsYoY));
                this.updateElementHTML('vendorLeadTimeChange', this.formatYoY(totals.leadTimeYoY));
            }

            updateElement(id, value) {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            }

            updateElementHTML(id, html) {
                const el = document.getElementById(id);
                if (el) el.innerHTML = html;
            }

            calculateTotals() {
                const totals = {
                    orderedUnits: 0,
                    orderedRevenue: 0,
                    pageViews: 0,
                    dailySales: 0,
                    shippedUnits: 0,
                    leadTime: 0,
                    sellableUnits: 0,
                    aged90Units: 0,
                    orderedUnitsYoY: null,
                    orderedRevenueYoY: null,
                    pageViewsYoY: null,
                    leadTimeYoY: null
                };

                let yoyData = { units: 0, revenue: 0, pageViews: 0, leadTime: 0 };
                let yoyCount = { units: 0, revenue: 0, pageViews: 0, leadTime: 0 };
                let leadTimeSum = 0;
                let leadTimeWeight = 0;

                this.processedData.forEach(item => {
                    totals.orderedUnits += item.orderedUnits;
                    totals.orderedRevenue += item.orderedRevenue;
                    totals.pageViews += item.pageViews;
                    totals.dailySales += item.dailySales;
                    totals.shippedUnits += item.dispatchedUnits;
                    totals.sellableUnits += item.sellableUnits || 0;
                    totals.aged90Units += item.aged90Units || 0;
                    
                    if (item.leadTime > 0 && item.orderedRevenue > 0) {
                        leadTimeSum += item.leadTime * item.orderedRevenue;
                        leadTimeWeight += item.orderedRevenue;
                    }

                    // FIXED: Use simple averaging instead of revenue-weighted for YoY
                    // This prevents extreme values from skewing the results
                    if (item.orderedUnitsYoY !== null && Math.abs(item.orderedUnitsYoY) < 1000) {
                        yoyData.units += item.orderedUnitsYoY;
                        yoyCount.units += 1;
                    }
                    if (item.orderedRevenueYoY !== null && Math.abs(item.orderedRevenueYoY) < 1000) {
                        yoyData.revenue += item.orderedRevenueYoY;
                        yoyCount.revenue += 1;
                    }
                    if (item.pageViewsYoY !== null && Math.abs(item.pageViewsYoY) < 1000) {
                        yoyData.pageViews += item.pageViewsYoY;
                        yoyCount.pageViews += 1;
                    }
                    if (item.leadTimeYoY !== null && Math.abs(item.leadTimeYoY) < 1000) {
                        yoyData.leadTime += item.leadTimeYoY;
                        yoyCount.leadTime += 1;
                    }
                });

                totals.conversionRate = totals.pageViews > 0 ? (totals.orderedUnits / totals.pageViews) * 100 : 0;
                totals.netPPM = this.calculateNetPPM();
                totals.aged90Percent = totals.sellableUnits > 0 ? (totals.aged90Units / totals.sellableUnits) * 100 : 0;
                totals.leadTime = leadTimeWeight > 0 ? leadTimeSum / leadTimeWeight : 0;

                // FIXED: Simple averaging for YoY to prevent extreme skewing
                totals.orderedUnitsYoY = yoyCount.units > 0 ? yoyData.units / yoyCount.units : null;
                totals.orderedRevenueYoY = yoyCount.revenue > 0 ? yoyData.revenue / yoyCount.revenue : null;
                totals.pageViewsYoY = yoyCount.pageViews > 0 ? yoyData.pageViews / yoyCount.pageViews : null;
                totals.leadTimeYoY = yoyCount.leadTime > 0 ? yoyData.leadTime / yoyCount.leadTime : null;

                return totals;
            }

            calculateNetPPM() {
                let totalRevenue = 0;
                let totalProfit = 0;

                this.processedData.forEach(item => {
                    totalRevenue += item.dispatchedRevenue;
                    totalProfit += (item.dispatchedRevenue - item.dispatchedCOGS);
                });

                return totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
            }

            populateInsights() {
                const avgConversion = this.processedData.reduce((sum, item) => sum + item.conversionRate, 0) / this.processedData.length;
                
                const allPageViews = this.processedData.map(item => item.pageViews).filter(pv => pv > 0).sort((a, b) => a - b);
                const medianPageViews = allPageViews[Math.floor(allPageViews.length / 2)] || 0;

                const topConverting = this.processedData
                    .filter(item => item.conversionRate > avgConversion * 1.15)
                    .slice(0, 20);

                const revenueRecovery = this.processedData
                    .filter(item => {
                        return item.conversionRate < avgConversion && 
                               item.orderedRevenue >= 1000 && 
                               item.pageViews > medianPageViews;
                    })
                    .sort((a, b) => b.orderedRevenue - a.orderedRevenue)
                    .slice(0, 20);

                if (revenueRecovery.length === 0) {
                    const fallback = this.processedData
                        .filter(item => item.conversionRate < avgConversion && item.orderedRevenue >= 1000)
                        .sort((a, b) => b.orderedRevenue - a.orderedRevenue)
                        .slice(0, 1);
                    revenueRecovery.push(...fallback);
                }

                const topRevenue = this.processedData.slice(0, 20);

                this.populateList('topConvertingList', topConverting, 'conversion');
                this.populateList('revenueRecoveryList', revenueRecovery, 'recovery');
                this.populateList('topRevenueList', topRevenue, 'revenue');
            }

            populateList(listId, items, type) {
                const list = document.getElementById(listId);
                if (!list) return;

                list.innerHTML = '';
                
                if (items.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'No products meet criteria';
                    list.appendChild(li);
                    return;
                }

                items.forEach(item => {
                    const li = document.createElement('li');
                    const title = item.productTitle.length > 40 ? 
                        item.productTitle.substring(0, 40) + '...' : 
                        item.productTitle;
                    
                    if (type === 'conversion') {
                        li.textContent = title + ' (' + item.conversionRate.toFixed(2) + '%)';
                    } else if (type === 'recovery') {
                        li.textContent = title + ' (¬£' + item.orderedRevenue.toLocaleString() + ', ' + item.conversionRate.toFixed(2) + '%)';
                    } else {
                        li.textContent = title + ' (¬£' + item.orderedRevenue.toLocaleString() + ')';
                    }
                    list.appendChild(li);
                });
            }

            createCharts() {
                this.destroyCharts();
                this.createRevenueChart();
                this.createProductsChart();
            }

            destroyCharts() {
                Object.values(this.charts).forEach(chart => {
                    if (chart && chart.destroy) chart.destroy();
                });
                this.charts = {};
            }

            createRevenueChart() {
                const ctx = document.getElementById('revenueChart');
                if (!ctx || !Chart) return;

                const topProducts = this.processedData.slice(0, 10);
                
                this.charts.revenue = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topProducts.map(p => p.productTitle.length > 30 ? 
                            p.productTitle.substring(0, 30) + '...' : p.productTitle),
                        datasets: [{
                            label: 'Revenue',
                            data: topProducts.map(p => p.orderedRevenue),
                            backgroundColor: 'rgba(34, 139, 34, 0.7)',
                            borderColor: 'rgba(34, 139, 34, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '¬£' + value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                ticks: { maxRotation: 45 }
                            }
                        }
                    }
                });
            }

            createProductsChart() {
                const ctx = document.getElementById('productsChart');
                if (!ctx || !Chart) return;

                const topProducts = this.processedData.slice(0, 8);
                
                this.charts.products = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: topProducts.map(p => p.productTitle.length > 25 ? 
                            p.productTitle.substring(0, 25) + '...' : p.productTitle),
                        datasets: [{
                            data: topProducts.map(p => p.orderedRevenue),
                            backgroundColor: [
                                '#228B22', '#32CD32', '#7CFC00', '#ADFF2F',
                                '#9ACD32', '#6B8E23', '#556B2F', '#8FBC8F'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    padding: 10
                                }
                            }
                        }
                    }
                });
            }

            populateTable() {
                const tbody = document.getElementById('performanceTableBody');
                if (!tbody) return;

                tbody.innerHTML = '';
                const limitedData = this.processedData.slice(0, 50);

                limitedData.forEach(item => {
                    const row = document.createElement('tr');
                    
                    const cells = [
                        item.asin,
                        item.productTitle.length > 40 ? item.productTitle.substring(0, 40) + '...' : item.productTitle,
                        item.orderedUnits.toLocaleString(),
                        '¬£' + item.orderedRevenue.toLocaleString(),
                        item.pageViews.toLocaleString(),
                        item.conversionRate.toFixed(2) + '%',
                        '¬£' + item.dailySales.toFixed(2),
                        item.dispatchedUnits.toLocaleString(),
                        item.aged90Percent.toFixed(1) + '%',
                        item.leadTime.toFixed(1),
                        item.netPPM.toFixed(1) + '%'
                    ];

                    cells.forEach(cellData => {
                        const cell = document.createElement('td');
                        cell.textContent = cellData;
                        row.appendChild(cell);
                    });

                    tbody.appendChild(row);
                });

                if (this.processedData.length > 50) {
                    const tableContainer = document.querySelector('.data-table');
                    if (tableContainer) {
                        const existingNote = tableContainer.querySelector('.table-limit-note');
                        if (existingNote) existingNote.remove();
                        
                        const note = document.createElement('p');
                        note.className = 'table-limit-note';
                        note.style.cssText = 'margin-top: 10px; font-style: italic; color: #666; text-align: center;';
                        note.textContent = 'Showing top 50 of ' + this.processedData.length + ' products. Export for full data.';
                        tableContainer.appendChild(note);
                    }
                }
            }

            exportExcel() {
                try {
                    if (!XLSX) {
                        this.showError('Excel library not loaded');
                        return;
                    }

                    const data = this.processedData.map(item => ({
                        'ASIN': item.asin,
                        'Product Title': item.productTitle,
                        'Ordered Units': item.orderedUnits,
                        'Ordered Revenue': item.orderedRevenue,
                        'Page Views': item.pageViews,
                        'Conversion Rate %': item.conversionRate.toFixed(2),
                        'Daily Sales': item.dailySales.toFixed(2),
                        'Shipped Units': item.dispatchedUnits,
                        '90+ Days Inventory %': item.aged90Percent.toFixed(1),
                        'Lead Time Days': item.leadTime.toFixed(1),
                        'Net PPM %': item.netPPM.toFixed(1)
                    }));

                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Analysis');
                    XLSX.writeFile(wb, 'vendor_analysis.xlsx');

                    this.showSuccess('Excel exported successfully!');
                } catch (error) {
                    this.showError('Export failed: ' + error.message);
                }
            }

            exportCSV() {
                try {
                    const headers = ['ASIN', 'Product Title', 'Ordered Units', 'Ordered Revenue', 'Page Views', 
                                   'Conversion Rate %', 'Daily Sales', 'Shipped Units', '90+ Days Inventory %', 'Lead Time Days', 'Net PPM %'];
                    
                    const csvContent = [headers].concat(
                        this.processedData.map(item => [
                            item.asin,
                            item.productTitle,
                            item.orderedUnits,
                            item.orderedRevenue,
                            item.pageViews,
                            item.conversionRate.toFixed(2),
                            item.dailySales.toFixed(2),
                            item.dispatchedUnits,
                            item.aged90Percent.toFixed(1),
                            item.leadTime.toFixed(1),
                            item.netPPM.toFixed(1)
                        ])
                    ).map(row => row.join(',')).join('\n');

                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'vendor_analysis.csv';
                    a.click();
                    URL.revokeObjectURL(url);

                    this.showSuccess('CSV exported successfully!');
                } catch (error) {
                    this.showError('Export failed: ' + error.message);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new VendorDashboard();
        });
    </script>
</body>
</html>
