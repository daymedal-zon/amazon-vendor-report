<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self';">
<title>Zon Amazon Analytics</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjOBaZBOA87z+IhZE9DA==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js" integrity="sha512-SGWgwwRA8xZgEoKiex3UubkSkV1zSE1BS6O4pXcaxcNtUlQsOmOmhVnDwIvqGRfEmuz83tIGL13cXMZn6upPyg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==" crossorigin="anonymous"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}
body {
font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
background: linear-gradient(135deg, #1A1A1A 0%, #2D2D2D 50%, #1A1A1A 100%);
min-height: 100vh;
color: #BFC3C9;
font-weight: 400;
}
.container {
max-width: 1400px;
margin: 0 auto;
padding: 20px;
}
.header {
text-align: center;
margin-bottom: 30px;
color: #BFC3C9;
padding: 40px 0;
background: linear-gradient(135deg, #007F5F 0%, #005D45 100%);
border-radius: 20px;
box-shadow: 0 20px 40px rgba(0, 127, 95, 0.3);
position: relative;
overflow: hidden;
}
.header::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: linear-gradient(45deg, transparent 45%, rgba(0, 255, 127, 0.03) 50%, transparent 55%);
z-index: 1;
}
.header h1 {
font-family: 'Orbitron', monospace;
font-size: 3.2rem;
margin-bottom: 15px;
font-weight: 900;
letter-spacing: 3px;
position: relative;
z-index: 2;
color: #00FF7F;
text-shadow:
0 0 20px rgba(0, 255, 127, 0.8),
0 0 40px rgba(0, 255, 127, 0.4),
2px 2px 4px rgba(0, 0, 0, 0.3);
}
.header p {
font-family: 'Inter', sans-serif;
font-size: 1.2rem;
margin: 0;
position: relative;
z-index: 2;
font-weight: 300;
letter-spacing: 0.5px;
color: #BFC3C9;
text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
opacity: 0.95;
}
.upload-section {
background: linear-gradient(135deg, #2D2D2D 0%, #1A1A1A 100%);
border: 1px solid #007F5F;
border-radius: 20px;
padding: 30px;
margin-bottom: 30px;
box-shadow: 0 15px 35px rgba(0, 127, 95, 0.2);
}
.upload-section h2 {
margin-bottom: 20px;
color: #BFC3C9;
text-align: center;
font-family: 'Orbitron', monospace;
font-weight: 700;
font-size: 1.5rem;
}
.note {
background: linear-gradient(135deg, #007F5F 0%, #005D45 100%);
border-left: 4px solid #00FF7F;
padding: 15px;
margin: 20px 0;
border-radius: 0 12px 12px 0;
font-size: 0.9rem;
color: #BFC3C9;
font-weight: 400;
}
.file-upload-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap: 20px;
margin-bottom: 20px;
}
.file-upload {
border: 2px dashed #007F5F;
border-radius: 15px;
padding: 25px;
text-align: center;
transition: all 0.3s ease;
cursor: pointer;
background: linear-gradient(135deg, #1A1A1A 0%, #2D2D2D 100%);
}
.file-upload:hover {
border-color: #00FF7F;
background: linear-gradient(135deg, #2D2D2D 0%, #1A1A1A 100%);
box-shadow: 0 10px 25px rgba(0, 255, 127, 0.2);
}
.file-upload.active {
border-color: #00FF7F;
background: linear-gradient(135deg, #007F5F 0%, #005D45 100%);
box-shadow: 0 15px 30px rgba(0, 255, 127, 0.3);
}
.file-upload.error {
border-color: #FF6B6B;
background: linear-gradient(135deg, #2D1A1A 0%, #1A1A1A 100%);
}
.file-upload.success {
border-color: #00FF7F;
background: linear-gradient(135deg, #1A2D1A 0%, #0D1A0D 100%);
}
.file-upload input {
display: none;
}
.file-upload label {
cursor: pointer;
font-weight: 600;
color: #BFC3C9;
display: block;
font-family: 'Inter', sans-serif;
}
.file-status {
margin-top: 10px;
font-size: 0.9rem;
font-weight: 500;
}
.file-status.success {
color: #00FF7F;
}
.file-status.error {
color: #FF6B6B;
}
.process-btn {
background: linear-gradient(135deg, #007F5F 0%, #005D45 100%);
color: #BFC3C9;
border: none;
padding: 15px 30px;
border-radius: 25px;
font-size: 1.1rem;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
display: block;
margin: 20px auto;
font-family: 'Orbitron', monospace;
letter-spacing: 1px;
box-shadow: 0 10px 25px rgba(0, 127, 95, 0.3);
}
.process-btn:hover:not(:disabled) {
transform: translateY(-3px);
box-shadow: 0 15px 35px rgba(0, 255, 127, 0.4);
background: linear-gradient(135deg, #00FF7F 0%, #007F5F 100%);
color: #1A1A1A;
}
.process-btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}
.error-message {
background: linear-gradient(135deg, #2D1A1A 0%, #1A1A1A 100%);
border: 1px solid #FF6B6B;
color: #FF9999;
padding: 15px;
border-radius: 12px;
margin: 20px 0;
display: none;
}
.success-message {
background: linear-gradient(135deg, #1A2D1A 0%, #0D1A0D 100%);
border: 1px solid #00FF7F;
color: #99FF99;
padding: 15px;
border-radius: 12px;
margin: 20px 0;
display: none;
}
.loading {
text-align: center;
padding: 40px;
color: #BFC3C9;
background: linear-gradient(135deg, #2D2D2D 0%, #1A1A1A 100%);
border: 1px solid #007F5F;
border-radius: 20px;
box-shadow: 0 15px 35px rgba(0, 127, 95, 0.2);
display: none;
}
.loading-spinner {
display: inline-block;
width: 20px;
height: 20px;
margin-left: 10px;
border: 2px solid #007F5F;
border-radius: 50%;
border-top-color: #00FF7F;
animation: spin 1s linear infinite;
}
@keyframes spin {
to { transform: rotate(360deg); }
}
.dashboard {
display: none;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 25px;
margin-top: 30px;
}
.dashboard.show {
display: grid;
}
.metric-card {
background: linear-gradient(135deg, #2D2D2D 0%, #1A1A1A 100%);
border: 1px solid #007F5F;
border-radius: 20px;
padding: 30px;
box-shadow: 0 15px 35px rgba(0, 127, 95, 0.2);
transition: all 0.3s ease;
position: relative;
overflow: hidden;
}
.metric-card::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 3px;
background: linear-gradient(90deg, #007F5F 0%, #00FF7F 50%, #007F5F 100%);
z-index: 1;
}
.metric-card:hover {
transform: translateY(-8px);
box-shadow: 0 25px 50px rgba(0, 255, 127, 0.3);
border-color: #00FF7F;
}
.metric-card h3 {
color: #BFC3C9;
margin-bottom: 20px;
font-size: 1rem;
text-transform: uppercase;
letter-spacing: 2px;
font-family: 'Orbitron', monospace;
font-weight: 700;
}
.metric-value {
font-size: 2.4rem;
font-weight: 900;
color: #00FF7F;
margin-bottom: 15px;
font-family: 'Orbitron', monospace;
text-shadow: 0 0 20px rgba(0, 255, 127, 0.5);
line-height: 1.1;
word-break: break-all;
}
.metric-change {
font-size: 0.95rem;
font-weight: 600;
font-family: 'Inter', sans-serif;
}
.metric-change.positive {
color: #00FF7F;
}
.metric-change.negative {
color: #FF6B6B;
}
.metric-change.neutral {
color: #BFC3C9;
}
.export-section {
grid-column: span 2;
text-align: center;
padding: 25px;
background: linear-gradient(135deg, #2D2D2D 0%, #1A1A1A 100%);
border: 1px solid #007F5F;
border-radius: 20px;
box-shadow: 0 15px 35px rgba(0, 127, 95, 0.2);
display: none;
}
.export-section.show {
display: block;
}
.export-section h3 {
color: #BFC3C9;
margin-bottom: 20px;
font-family: 'Orbitron', monospace;
font-weight: 700;
}
.export-btn {
background: linear-gradient(135deg, #007F5F 0%, #005D45 100%);
color: #BFC3C9;
border: none;
padding: 12px 20px;
border-radius: 12px;
margin: 5px;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
font-family: 'Inter', sans-serif;
box-shadow: 0 8px 20px rgba(0, 127, 95, 0.3);
min-width: 160px;
flex: 1;
max-width: 200px;
}
.export-btn:hover {
background: linear-gradient(135deg, #00FF7F 0%, #007F5F 100%);
transform: translateY(-2px);
box-shadow: 0 12px 25px rgba(0, 255, 127, 0.4);
color: #1A1A1A;
}
.chart-container {
grid-column: span 2;
background: linear-gradient(135deg, #2D2D2D 0%, #1A1A1A 100%);
border: 1px solid #007F5F;
border-radius: 20px;
padding: 30px;
box-shadow: 0 15px 35px rgba(0, 127, 95, 0.2);
height: 400px;
}
.chart-container h3 {
color: #BFC3C9;
margin-bottom: 20px;
font-family: 'Orbitron', monospace;
font-weight: 700;
}
.chart-container canvas {
max-height: 320px !important;
}
.data-table {
grid-column: span 3;
background: linear-gradient(135deg, #2D2D2D 0%, #1A1A1A 100%);
border: 1px solid #007F5F;
border-radius: 20px;
padding: 30px;
box-shadow: 0 15px 35px rgba(0, 127, 95, 0.2);
overflow-x: auto;
}
.summary-section {
grid-column: span 3;
background: linear-gradient(135deg, #2D2D2D 0%, #1A1A1A 100%);
border: 1px solid #007F5F;
border-radius: 20px;
padding: 30px;
box-shadow: 0 15px 35px rgba(0, 127, 95, 0.2);
}
.summary-section h3 {
color: #BFC3C9;
margin-bottom: 20px;
font-family: 'Orbitron', monospace;
font-weight: 700;
}
.summary-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 25px;
margin-top: 20px;
}
.summary-card {
background: linear-gradient(135deg, #1A1A1A 0%, #2D2D2D 100%);
border: 1px solid #007F5F;
border-radius: 15px;
padding: 25px;
border-left: 4px solid #00FF7F;
}
.summary-card h4 {
color: #00FF7F;
margin-bottom: 15px;
font-size: 1.1rem;
font-family: 'Orbitron', monospace;
font-weight: 700;
}
.summary-card p {
color: #BFC3C9;
margin-bottom: 15px;
font-size: 0.9rem;
line-height: 1.5;
}
.summary-list {
list-style: none;
padding: 0;
}
.summary-list li {
padding: 12px 0;
border-bottom: 1px solid #007F5F;
font-size: 0.9rem;
color: #BFC3C9;
line-height: 1.4;
}
.summary-list li:last-child {
border-bottom: none;
}
.data-table h3 {
color: #BFC3C9;
margin-bottom: 20px;
font-family: 'Orbitron', monospace;
font-weight: 700;
}
.data-table p {
color: #BFC3C9;
margin-bottom: 15px;
font-size: 0.9rem;
}
table {
width: 100%;
border-collapse: collapse;
margin-top: 15px;
}
th, td {
text-align: left;
padding: 15px 12px;
border-bottom: 1px solid #007F5F;
color: #BFC3C9;
}
th {
background: linear-gradient(135deg, #007F5F 0%, #005D45 100%);
font-weight: 700;
color: #BFC3C9;
position: sticky;
top: 0;
font-family: 'Inter', sans-serif;
font-size: 0.9rem;
text-transform: uppercase;
letter-spacing: 1px;
}
tr:hover {
background: linear-gradient(135deg, rgba(0, 127, 95, 0.1) 0%, rgba(0, 255, 127, 0.05) 100%);
}
.version-info {
position: fixed;
bottom: 15px;
right: 15px;
background: linear-gradient(135deg, #1A1A1A 0%, #007F5F 100%);
color: #00FF7F;
padding: 8px 15px;
border-radius: 20px;
font-size: 0.8rem;
z-index: 1000;
font-family: 'Orbitron', monospace;
font-weight: 700;
border: 1px solid #007F5F;
box-shadow: 0 5px 15px rgba(0, 127, 95, 0.3);
}
@media (max-width: 768px) {
.chart-container,
.data-table,
.summary-section {
grid-column: span 1;
}
.header h1 {
font-size: 2.4rem;
letter-spacing: 2px;
}
.metric-value {
font-size: 2.2rem;
}
.file-upload-grid {
grid-template-columns: 1fr;
}
.export-section {
grid-column: span 1;
}
.export-section div {
flex-direction: column;
}
.export-btn {
max-width: none;
width: 100%;
}
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>Zon Amazon Analytics</h1>
<p>See inside the machine</p>
</div>
<div class="upload-section">
<h2>Upload Your Excel Reports</h2>
<div class="note">
<strong>Note:</strong> Supports both US and UK Amazon Vendor Central formats. Supports files up to 50MB.
</div>
<div class="error-message" id="errorMessage"></div>
<div class="success-message" id="successMessage"></div>
<div class="file-upload-grid">
<div class="file-upload" id="salesUpload">
<input type="file" id="salesFile" accept=".xlsx,.xls,.csv" />
<label for="salesFile">
üìä Upload Sales Report<br>
<small>Sales_ASIN_Manufacturing_Retail_*.xlsx</small>
</label>
<div class="file-status" id="salesStatus"></div>
</div>
<div class="file-upload" id="trafficUpload">
<input type="file" id="trafficFile" accept=".xlsx,.xls,.csv" />
<label for="trafficFile">
üö¶ Upload Traffic Report<br>
<small>Traffic_ASIN_*.xlsx</small>
</label>
<div class="file-status" id="trafficStatus"></div>
</div>
<div class="file-upload" id="inventoryUpload">
<input type="file" id="inventoryFile" accept=".xlsx,.xls,.csv" />
<label for="inventoryFile">
üì¶ Upload Inventory Report<br>
<small>Inventory_ASIN_Manufacturing_Retail_*.xlsx</small>
</label>
<div class="file-status" id="inventoryStatus"></div>
</div>
</div>
<button class="process-btn" id="processBtn" disabled>Generate Dashboard</button>
</div>
<div id="loading" class="loading">
Processing your data...<span class="loading-spinner"></span>
</div>
<div class="dashboard" id="dashboard">
<div class="metric-card">
<h3>Ordered Units</h3>
<div class="metric-value" id="orderedUnits">0</div>
<div class="metric-change" id="orderedUnitsChange"></div>
</div>
<div class="metric-card">
<h3>Ordered Revenue</h3>
<div class="metric-value" id="orderedRevenue">¬£0</div>
<div class="metric-change" id="orderedRevenueChange"></div>
</div>
<div class="metric-card">
<h3>Featured Page Views</h3>
<div class="metric-value" id="pageViews">0</div>
<div class="metric-change" id="pageViewsChange"></div>
</div>
<div class="metric-card">
<h3>Conversion Rate</h3>
<div class="metric-value" id="conversionRate">0%</div>
<div class="metric-change" id="conversionRateChange"></div>
</div>
<div class="metric-card">
<h3>Daily Sales</h3>
<div class="metric-value" id="dailySales">¬£0</div>
<div class="metric-change" id="dailySalesChange"></div>
</div>
<div class="metric-card">
<h3>Net PPM %</h3>
<div class="metric-value" id="netPPM">0%</div>
<div class="metric-change" id="netPPMChange"></div>
</div>
<div class="metric-card">
<h3>Vendor Lead Time</h3>
<div class="metric-value" id="vendorLeadTime">0 days</div>
<div class="metric-change" id="vendorLeadTimeChange"></div>
</div>
<div class="metric-card">
<h3>90+ Days Inventory %</h3>
<div class="metric-value" id="aged90Percent">0%</div>
<div class="metric-change" id="aged90PercentChange"></div>
</div>
<div class="metric-card">
<h3>Low Stock Titles</h3>
<div class="metric-value" id="lowStockTitles">0</div>
<div class="metric-change" id="lowStockTitlesChange">‚â§14 days stock</div>
</div>
<div class="export-section show" id="exportSection">
<h3>Export Your Report</h3>
<div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
<button class="export-btn" id="exportExcel">üìä Export to Excel</button>
<button class="export-btn" id="exportCSV">üìã Export to CSV</button>
</div>
</div>
<div class="chart-container">
<h3>Revenue Trend</h3>
<canvas id="revenueChart"></canvas>
</div>
<div class="chart-container">
<h3>Brand & Series Revenue</h3>
<canvas id="brandSeriesChart"></canvas>
</div>
<div class="summary-section">
<h3>Performance Insights</h3>
<div class="summary-grid">
<div class="summary-card">
<h4>üèÜ Top Converting Products</h4>
<p>Products performing 15%+ above average conversion rate</p>
<ul class="summary-list" id="topConvertingList"></ul>
</div>
<div class="summary-card">
<h4>üí∞ Revenue Recovery Opportunities</h4>
<p>High-impact products (¬£1k+) with conversion gaps and/or aged inventory - includes stock risk analysis</p>
<ul class="summary-list" id="revenueRecoveryList"></ul>
</div>
<div class="summary-card">
<h4>üìö Smart Brand & Series Analysis</h4>
<p>Intelligent grouping of your products by publisher, series, and collections</p>
<ul class="summary-list" id="brandSeriesList"></ul>
</div>
</div>
</div>
<div class="data-table">
<h3>Product Performance Summary (Top 50)</h3>
<p style="color: #BFC3C9; margin-bottom: 15px;">Limited to top 50 products by revenue. Export for complete dataset.</p>
<div style="overflow-x: auto;">
<table id="performanceTable">
<thead>
<tr>
<th>ASIN</th>
<th>Product Title</th>
<th>Ordered Units</th>
<th>Ordered Revenue</th>
<th>Page Views</th>
<th>Conversion Rate</th>
<th>Daily Sales</th>
<th>Lead Time (days)</th>
<th>90+ Days Inventory %</th>
<th>Days of Stock</th>
<th>Net PPM %</th>
</tr>
</thead>
<tbody id="performanceTableBody">
</tbody>
</table>
</div>
</div>
</div>
<div class="version-info">
v1.9 | Zon Analytics
</div>
</div>
<script>
class VendorDashboard {
constructor() {
this.salesData = [];
this.trafficData = [];
this.inventoryData = [];
this.processedData = [];
this.charts = {};
this.daysInPeriod = 42;
this.maxFileSize = 50 * 1024 * 1024;
this.init();
}

init() {
try {
this.bindEvents();
console.log('Dashboard initialized successfully');
} catch (error) {
console.error('Init failed:', error);
this.showError('Failed to initialize dashboard');
}
}

// ENHANCED US/UK DATE FORMAT SUPPORT
normalizeTrafficData(filename) {
try {
const trafficDays = this.calculateDaysFromFilename(filename);
const expectedDays = this.daysInPeriod;
if (trafficDays > expectedDays) {
const extraDays = trafficDays - expectedDays;
console.log(`Traffic data has ${extraDays} extra day(s). Normalizing...`);
this.trafficData.forEach(row => {
const pageViewsCol = 'Featured offer page views';
const pageViews = parseInt(String(row[pageViewsCol] || 0).replace(/[,]/g, '')) || 0;
if (pageViews > 0) {
const dailyAverage = pageViews / trafficDays;
const adjustedPageViews = Math.round(dailyAverage * expectedDays);
row[pageViewsCol] = adjustedPageViews;
console.log(`ASIN ${row.ASIN}: ${pageViews} ‚Üí ${adjustedPageViews} page views (removed ${extraDays} day)`);
}
});
console.log(`‚úÖ Traffic data normalized from ${trafficDays} to ${expectedDays} days`);
}
} catch (error) {
console.warn('Traffic normalization failed:', error);
}
}

calculateDaysFromFilename(filename) {
try {
// First try UK format (DDMMYYYY)
let dateMatch = filename.match(/(\d{2}[\-]?\d{2}[\-]?\d{4})_(\d{2}[\-]?\d{2}[\-]?\d{4})/);
// If no UK format found, try US format (MMDDYYYY) - HEP Support
if (!dateMatch) {
dateMatch = filename.match(/(\d{6,8})_(\d{6,8})/);
if (dateMatch) {
console.log('üá∫üá∏ Detected US date format (MMDDYYYY) - HEP Compatible');
const startDateStr = dateMatch[1];
const endDateStr = dateMatch[2];
let startMonth, startDay, startYear, endMonth, endDay, endYear;
// Parse start date (US format: MMDDYYYY or MMDDYY)
if (startDateStr.length === 6) {
// MMDDYY format
startMonth = parseInt(startDateStr.substring(0, 2)) - 1;
startDay = parseInt(startDateStr.substring(2, 4));
startYear = parseInt(startDateStr.substring(4, 8));
} else {
// MDDYY format (single digit month)
startMonth = parseInt(startDateStr.substring(0, 1)) - 1;
startDay = parseInt(startDateStr.substring(1, 3));
startYear = 2000 + parseInt(startDateStr.substring(3, 5));
}

// Parse end date (US format)
if (endDateStr.length === 6) {
endMonth = parseInt(endDateStr.substring(0, 2)) - 1;
endDay = parseInt(endDateStr.substring(2, 4));
endYear = 2000 + parseInt(endDateStr.substring(4, 6));
} else if (endDateStr.length === 8) {
endMonth = parseInt(endDateStr.substring(0, 2)) - 1;
endDay = parseInt(endDateStr.substring(2, 4));
endYear = parseInt(endDateStr.substring(4, 8));
} else {
endMonth = parseInt(endDateStr.substring(0, 1)) - 1;
endDay = parseInt(endDateStr.substring(1, 3));
endYear = 2000 + parseInt(endDateStr.substring(3, 5));
}

const startDate = new Date(startYear, startMonth, startDay);
const endDate = new Date(endYear, endMonth, endDay);
const diffTime = Math.abs(endDate - startDate);
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
this.daysInPeriod = diffDays;
console.log(`‚úÖ US Format: ${diffDays} days (${startMonth+1}/${startDay}/${startYear} to ${endMonth+1}/${endDay}/${endYear})`);
return diffDays;
}
}

// UK format parsing (existing logic)
if (dateMatch) {
console.log('üá¨üáß Detected UK date format (DDMMYYYY)');
const startDateStr = dateMatch[1].replace(/[\-]/g, '');
const endDateStr = dateMatch[2].replace(/[\-]/g, '');
const startDay = parseInt(startDateStr.substring(0, 2));
const startMonth = parseInt(startDateStr.substring(2, 4)) - 1;
const startYear = parseInt(startDateStr.substring(4, 8));
const endDay = parseInt(endDateStr.substring(0, 2));
const endMonth = parseInt(endDateStr.substring(2, 4)) - 1;
const endYear = parseInt(endDateStr.substring(4, 8));
const startDate = new Date(startYear, startMonth, startDay);
const endDate = new Date(endYear, endMonth, endDay);
const diffTime = Math.abs(endDate - startDate);
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
this.daysInPeriod = diffDays;
console.log(`‚úÖ UK Format: ${diffDays} days (${startDay}/${startMonth+1}/${startYear} to ${endDay}/${endMonth+1}/${endYear})`);
return diffDays;
}
} catch (error) {
console.warn('Could not parse date from filename, using default 46 days:', error);
this.daysInPeriod = 46;
}
return this.daysInPeriod;
}

bindEvents() {
const salesFile = document.getElementById('salesFile');
const trafficFile = document.getElementById('trafficFile');
const inventoryFile = document.getElementById('inventoryFile');
const processBtn = document.getElementById('processBtn');
if (salesFile) salesFile.addEventListener('change', (e) => this.handleFile(e, 'sales'));
if (trafficFile) trafficFile.addEventListener('change', (e) => this.handleFile(e, 'traffic'));
if (inventoryFile) inventoryFile.addEventListener('change', (e) => this.handleFile(e, 'inventory'));
if (processBtn) processBtn.addEventListener('click', () => this.processData());
}

bindExportEvents() {
const exportExcel = document.getElementById('exportExcel');
const exportCSV = document.getElementById('exportCSV');
if (exportExcel) exportExcel.addEventListener('click', () => this.exportExcel());
if (exportCSV) exportCSV.addEventListener('click', () => this.exportCSV());
}

showError(msg) {
const div = document.getElementById('errorMessage');
if (div) {
div.textContent = msg;
div.style.display = 'block';
setTimeout(() => div.style.display = 'none', 5000);
}
}

showSuccess(msg) {
const div = document.getElementById('successMessage');
if (div) {
div.textContent = msg;
div.style.display = 'block';
setTimeout(() => div.style.display = 'none', 3000);
}
}

updateFileStatus(type, status, msg) {
const statusDiv = document.getElementById(type + 'Status');
const uploadDiv = document.getElementById(type + 'Upload');
if (statusDiv) {
statusDiv.textContent = msg;
statusDiv.className = 'file-status ' + status;
}
if (uploadDiv) {
uploadDiv.className = 'file-upload ' + status;
}
}

validateFile(file) {
if (!file) throw new Error('No file selected');
if (file.size > this.maxFileSize) {
throw new Error('File too large');
}
return true;
}

handleFile(event, type) {
const file = event.target.files[0];
try {
this.validateFile(file);
this.updateFileStatus(type, 'active', 'Processing...');
this.calculateDaysFromFilename(file.name);
if (file.name.match(/\.(xlsx|xls)$/i)) {
this.processExcel(file, type);
} else {
this.processCSV(file, type);
}
} catch (error) {
this.updateFileStatus(type, 'error', error.message);
this.showError('Error: ' + error.message);
}
}

processExcel(file, type) {
const reader = new FileReader();
reader.onload = (e) => {
try {
const data = new Uint8Array(e.target.result);
const workbook = XLSX.read(data, { type: 'array' });
const sheet = workbook.Sheets[workbook.SheetNames[0]];
const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
if (jsonData.length < 2) {
throw new Error('File appears empty');
}
const headers = jsonData[0];
const rows = jsonData.slice(1);
this[type + 'Data'] = rows.map(row => {
const obj = {};
headers.forEach((header, index) => {
obj[String(header).trim()] = row[index] || '';
});
return obj;
}).filter(row => Object.values(row).some(val => val !== ''));

if (type === 'traffic') {
this.normalizeTrafficData(file.name);
}

this.updateFileStatus(type, 'success', '‚úÖ Loaded ' + this[type + 'Data'].length + ' rows');
this.checkReady();
} catch (error) {
this.updateFileStatus(type, 'error', error.message);
this.showError('Excel error: ' + error.message);
}
};
reader.readAsArrayBuffer(file);
}

processCSV(file, type) {
const reader = new FileReader();
reader.onload = (e) => {
try {
const csv = e.target.result;
const parsed = Papa.parse(csv, {
header: true,
skipEmptyLines: true
});

this[type + 'Data'] = parsed.data.filter(row =>
Object.values(row).some(val => val !== null && val !== '')
);

if (type === 'traffic') {
this.normalizeTrafficData(file.name);
}

this.updateFileStatus(type, 'success', '‚úÖ Loaded ' + this[type + 'Data'].length + ' rows');
this.checkReady();
} catch (error) {
this.updateFileStatus(type, 'error', error.message);
this.showError('CSV error: ' + error.message);
}
};
reader.readAsText(file);
}

checkReady() {
const ready = this.salesData.length > 0 &&
this.trafficData.length > 0 &&
this.inventoryData.length > 0;
const btn = document.getElementById('processBtn');
if (btn) btn.disabled = !ready;
if (ready) {
this.showSuccess('Ready to process!');
}
}

processData() {
const loading = document.getElementById('loading');
const dashboard = document.getElementById('dashboard');
const exportSection = document.getElementById('exportSection');
if (loading) loading.style.display = 'block';
if (dashboard) dashboard.classList.remove('show');
if (exportSection) exportSection.classList.remove('show');
setTimeout(() => {
try {
this.processedData = this.mergeData();
if (this.processedData.length === 0) {
throw new Error('No data to process');
}
this.updateDashboard();
this.createCharts();
this.populateTable();
this.populateInsights();
if (loading) loading.style.display = 'none';
if (dashboard) dashboard.classList.add('show');
if (exportSection) exportSection.classList.add('show');
this.bindExportEvents();
this.showSuccess('Dashboard ready with ' + this.processedData.length + ' products!');
} catch (error) {
if (loading) loading.style.display = 'none';
this.showError('Processing failed: ' + error.message);
console.error('Processing error:', error);
}
}, 100);
}

parseNum(value) {
if (!value) return 0;
const str = String(value).replace(/[,¬£$]/g, '');
return parseFloat(str) || 0;
}

parseYoY(value) {
if (!value || value === '' || value === null || value === undefined) return null;
const num = parseFloat(value);
if (isNaN(num)) return null;
if (Math.abs(num) <= 1) {
return Math.round(num * 10000) / 100;
} else if (Math.abs(num) > 1 && Math.abs(num) <= 100) {
return Math.round(num * 100) / 100;
} else {
return Math.round(num) / 100;
}
}

// ENHANCED COLUMN SUPPORT - US/UK Variations
mergeData() {
const merged = [];
try {
console.log('üîÑ Starting data merge with US/UK column support...');

// DEBUG: Log actual column names from uploaded files
console.log('=== SALES COLUMNS (first 5) ===');
console.log(Object.keys(this.salesData[0]).slice(0, 5));
console.log('=== TRAFFIC COLUMNS (first 5) ===');  
console.log(Object.keys(this.trafficData[0]).slice(0, 5));
console.log('=== INVENTORY COLUMNS (first 5) ===');
console.log(Object.keys(this.inventoryData[0]).slice(0, 5));
console.log('========================');

if (!this.salesData || this.salesData.length === 0) {
throw new Error('Sales data is empty');
}
if (!this.trafficData || this.trafficData.length === 0) {
throw new Error('Traffic data is empty');
}
if (!this.inventoryData || this.inventoryData.length === 0) {
throw new Error('Inventory data is empty');
}

const trafficMap = new Map();
this.trafficData.forEach(row => {
if (row && row.ASIN) trafficMap.set(String(row.ASIN), row);
});

const inventoryMap = new Map();
this.inventoryData.forEach(row => {
if (row && row.ASIN) inventoryMap.set(String(row.ASIN), row);
});

console.log(`Processing ${this.salesData.length} sales rows...`);

this.salesData.forEach((salesRow, index) => {
try {
if (!salesRow || !salesRow.ASIN) return;
const asin = String(salesRow.ASIN);
const trafficRow = trafficMap.get(asin) || {};
const inventoryRow = inventoryMap.get(asin) || {};

// üá∫üá∏üá¨üáß MULTI-FORMAT COLUMN SUPPORT
const orderedUnits = this.parseNum(
salesRow['Ordered units'] || // UK format
salesRow['Ordered Units'] // US format
) || 0;

const orderedRevenue = this.parseNum(
salesRow['Ordered revenue'] || // UK format
salesRow['Ordered Revenue'] // US format
) || 0;

if (orderedUnits === 0 && orderedRevenue === 0) return;

const dispatchedRevenue = this.parseNum(
salesRow['Dispatched revenue'] || // UK format
salesRow['Shipped Revenue'] // US format
) || 0;

const dispatchedCOGS = this.parseNum(
salesRow['Dispatched COGS'] || // UK format
salesRow['Shipped COGS'] // US format
) || 0;

const pageViews = this.parseNum(trafficRow['Featured offer page views']) || 0;

// üìä YoY SUPPORT - Multiple Punctuation Formats
const orderedRevenueYoYRaw = this.parseYoY(
salesRow['Ordered Revenue ‚Äì Same Period Last Year (%)'] || // UK (en dash)
salesRow['Ordered Revenue - Same Period Last Year (%)'] // US (hyphen)
);

const orderedUnitsYoYRaw = this.parseYoY(
salesRow['Ordered Units ‚Äì Same Period Last Year (%)'] || // UK (en dash)
salesRow['Ordered Units - Same Period Last Year (%)'] // US (hyphen)
);

const pageViewsYoYRaw = this.parseYoY(
trafficRow['Featured offer page views ‚Äì Same Period Last Year (%)'] || // UK
trafficRow['Featured offer page views - Same Period Last Year (%)'] // US
);

let lastPeriodRevenue = null;
let lastPeriodUnits = null;
let lastPeriodPageViews = null;
let calculatedRevenueYoY = null;
let calculatedUnitsYoY = null;
let calculatedPageViewsYoY = null;

if (orderedRevenueYoYRaw !== null && orderedRevenue > 0) {
lastPeriodRevenue = orderedRevenue / (1 + (orderedRevenueYoYRaw / 100));
calculatedRevenueYoY = ((orderedRevenue - lastPeriodRevenue) / lastPeriodRevenue) * 100;
}

if (orderedUnitsYoYRaw !== null && orderedUnits > 0) {
lastPeriodUnits = orderedUnits / (1 + (orderedUnitsYoYRaw / 100));
calculatedUnitsYoY = ((orderedUnits - lastPeriodUnits) / lastPeriodUnits) * 100;
}

if (pageViewsYoYRaw !== null && pageViews > 0) {
lastPeriodPageViews = pageViews / (1 + (pageViewsYoYRaw / 100));
calculatedPageViewsYoY = ((pageViews - lastPeriodPageViews) / lastPeriodPageViews) * 100;
}

// üì¶ INVENTORY COLUMN VARIATIONS
const vendorLeadTime = this.parseNum(
inventoryRow['Overall Vendor Lead Time (days)'] ||
inventoryRow['Vendor Lead Time (days)'] ||
inventoryRow['Lead Time (days)'] ||
0
);

const sellableUnits = this.parseNum(
inventoryRow['Sellable On Hand Units'] ||
inventoryRow['Sellable On-Hand Units'] ||
inventoryRow['Sellable Inventory Units'] ||
0
);

const aged90Units = this.parseNum(
inventoryRow['Aged 90+ Days Sellable Units'] ||
inventoryRow['Aged 90+ Days Sellable Inventory'] ||
inventoryRow['90+ Days Sellable Units'] ||
0
);

const conversionRate = pageViews > 0 ? (orderedUnits / pageViews) * 100 : 0;
const dailySales = orderedRevenue / this.daysInPeriod;
const netPPM = dispatchedRevenue > 0 ? ((dispatchedRevenue - dispatchedCOGS) / dispatchedRevenue) * 100 : 0;
const aged90Percent = sellableUnits > 0 ? (aged90Units / sellableUnits) * 100 : 0;

const dispatchedUnitsYoY = this.parseYoY(
salesRow['Dispatched Units ‚Äì Same Period Last Year (%)'] ||
salesRow['Dispatched Units - Same Period Last Year (%)'] ||
salesRow['Shipped Units ‚Äì Same Period Last Year (%)'] ||
salesRow['Shipped Units - Same Period Last Year (%)']
);

const vendorLeadTimeYoY = this.parseYoY(
inventoryRow['Overall Vendor Lead Time (days) ‚Äì Same Period Last Year (%)'] ||
inventoryRow['Overall Vendor Lead Time (days) - Same Period Last Year (%)']
);

const aged90YoY = this.parseYoY(
inventoryRow['Aged 90+ Days Sellable Units ‚Äì Same Period Last Year (%)'] ||
inventoryRow['Aged 90+ Days Sellable Units - Same Period Last Year (%)']
);

merged.push({
asin: asin,
title: salesRow['Product title'] || salesRow['Product Title'] || '', // US/UK support
brand: salesRow['Brand'] || '',
orderedUnits: orderedUnits,
orderedRevenue: orderedRevenue,
dispatchedRevenue: dispatchedRevenue,
dispatchedCOGS: dispatchedCOGS,
pageViews: pageViews,
conversionRate: conversionRate,
dailySales: dailySales,
netPPM: netPPM,
leadTime: vendorLeadTime,
sellableUnits: sellableUnits,
aged90Units: aged90Units,
aged90Percent: aged90Percent,
orderedRevenueYoY: calculatedRevenueYoY,
orderedUnitsYoY: calculatedUnitsYoY,
dispatchedUnitsYoY: dispatchedUnitsYoY,
pageViewsYoY: calculatedPageViewsYoY,
leadTimeYoY: vendorLeadTimeYoY,
aged90YoY: aged90YoY,
lastPeriodRevenue: lastPeriodRevenue,
lastPeriodUnits: lastPeriodUnits,
lastPeriodPageViews: lastPeriodPageViews
});

} catch (rowError) {
console.warn(`Row processing error at index ${index}:`, rowError);
}
});

console.log(`‚úÖ Successfully processed ${merged.length} products with US/UK column support`);
return merged;
} catch (error) {
console.error('Merge data error:', error);
throw new Error('Failed to merge data: ' + error.message);
}
}

updateDashboard() {
try {
const totals = this.calculateTotals();

const lowStockCount = this.processedData.filter(item => {
const dailySalesUnits = item.orderedUnits / this.daysInPeriod;
if (dailySalesUnits <= 0) return false;
const stockDays = item.sellableUnits / dailySalesUnits;
const riskDays = stockDays - item.leadTime;
return riskDays <= 14;
}).length;

this.updateElement('orderedUnits', totals.orderedUnits.toLocaleString());
this.updateElement('orderedRevenue', '¬£' + Math.round(totals.orderedRevenue).toLocaleString());
this.updateElement('pageViews', totals.pageViews.toLocaleString());
this.updateElement('conversionRate', totals.conversionRate.toFixed(2) + '%');
this.updateElement('dailySales', '¬£' + Math.round(totals.dailySales).toLocaleString());
this.updateElement('netPPM', totals.netPPM.toFixed(1) + '%');
this.updateElement('vendorLeadTime', totals.leadTime.toFixed(0) + ' days');
this.updateElement('aged90Percent', totals.aged90Percent.toFixed(1) + '%');
this.updateElement('lowStockTitles', lowStockCount.toString());

this.updateYoYChange('orderedUnitsChange', totals.orderedUnitsYoY);
this.updateYoYChange('orderedRevenueChange', totals.orderedRevenueYoY);
this.updateYoYChange('pageViewsChange', totals.pageViewsYoY);
this.updateYoYChange('conversionRateChange', totals.conversionRateYoY);
this.updateYoYChange('dailySalesChange', totals.orderedRevenueYoY);
this.updateYoYChange('netPPMChange', totals.netPPMYoY);
this.updateYoYChange('vendorLeadTimeChange', totals.leadTimeYoY);
this.updateYoYChange('aged90PercentChange', totals.aged90YoY);

} catch (error) {
console.error('Dashboard update error:', error);
throw error;
}
}

calculateTotals() {
const totals = {
orderedUnits: 0,
orderedRevenue: 0,
pageViews: 0,
dailySales: 0,
netPPMWeighted: 0,
netPPMWeight: 0,
leadTimeWeighted: 0,
leadTimeWeight: 0,
aged90Units: 0,
sellableUnits: 0,
lastPeriodRevenue: 0,
lastPeriodUnits: 0,
lastPeriodPageViews: 0
};

const yoyValues = {
orderedUnits: [],
orderedRevenue: [],
pageViews: [],
vendorLeadTime: [],
aged90: []
};

this.processedData.forEach(item => {
totals.orderedUnits += item.orderedUnits;
totals.orderedRevenue += item.orderedRevenue;
totals.pageViews += item.pageViews;
totals.dailySales += item.dailySales;
totals.aged90Units += item.aged90Units;
totals.sellableUnits += item.sellableUnits;

if (item.lastPeriodRevenue) totals.lastPeriodRevenue += item.lastPeriodRevenue;
if (item.lastPeriodUnits) totals.lastPeriodUnits += item.lastPeriodUnits;
if (item.lastPeriodPageViews) totals.lastPeriodPageViews += item.lastPeriodPageViews;

if (item.orderedRevenue > 0) {
totals.netPPMWeighted += item.netPPM * item.orderedRevenue;
totals.netPPMWeight += item.orderedRevenue;
totals.leadTimeWeighted += item.leadTime * item.orderedRevenue;
totals.leadTimeWeight += item.orderedRevenue;
}

if (item.orderedUnitsYoY !== null && Math.abs(item.orderedUnitsYoY) < 1000) {
yoyValues.orderedUnits.push(item.orderedUnitsYoY);
}
if (item.orderedRevenueYoY !== null && Math.abs(item.orderedRevenueYoY) < 1000) {
yoyValues.orderedRevenue.push(item.orderedRevenueYoY);
}
if (item.pageViewsYoY !== null && Math.abs(item.pageViewsYoY) < 1000) {
yoyValues.pageViews.push(item.pageViewsYoY);
}
if (item.leadTimeYoY !== null && Math.abs(item.leadTimeYoY) < 1000) {
yoyValues.vendorLeadTime.push(item.leadTimeYoY);
}
if (item.aged90YoY !== null && Math.abs(item.aged90YoY) < 1000) {
yoyValues.aged90.push(item.aged90YoY);
}
});

const totalRevenueYoY = totals.lastPeriodRevenue > 0 ?
((totals.orderedRevenue - totals.lastPeriodRevenue) / totals.lastPeriodRevenue) * 100 : null;

const totalUnitsYoY = totals.lastPeriodUnits > 0 ?
((totals.orderedUnits - totals.lastPeriodUnits) / totals.lastPeriodUnits) * 100 : null;

const totalPageViewsYoY = totals.lastPeriodPageViews > 0 ?
((totals.pageViews - totals.lastPeriodPageViews) / totals.lastPeriodPageViews) * 100 : null;

return {
orderedUnits: totals.orderedUnits,
orderedRevenue: totals.orderedRevenue,
pageViews: totals.pageViews,
conversionRate: totals.pageViews > 0 ? (totals.orderedUnits / totals.pageViews) * 100 : 0,
dailySales: totals.dailySales,
netPPM: totals.netPPMWeight > 0 ? totals.netPPMWeighted / totals.netPPMWeight : 0,
leadTime: totals.leadTimeWeight > 0 ? totals.leadTimeWeighted / totals.leadTimeWeight : 0,
aged90Percent: totals.sellableUnits > 0 ? (totals.aged90Units / totals.sellableUnits) * 100 : 0,
orderedUnitsYoY: totalUnitsYoY,
orderedRevenueYoY: totalRevenueYoY,
pageViewsYoY: totalPageViewsYoY,
conversionRateYoY: totalUnitsYoY,
netPPMYoY: totalRevenueYoY,
leadTimeYoY: this.calculateAverage(yoyValues.vendorLeadTime),
aged90YoY: this.calculateAverage(yoyValues.aged90)
};
}

calculateAverage(values) {
if (!values || values.length === 0) return null;
const sum = values.reduce((a, b) => a + b, 0);
return sum / values.length;
}

updateElement(id, value) {
const element = document.getElementById(id);
if (element) element.textContent = value;
}

updateYoYChange(id, value) {
const element = document.getElementById(id);
if (!element) return;

if (value === null || value === undefined) {
element.textContent = 'N/A';
element.className = 'metric-change neutral';
return;
}

const formatted = (value >= 0 ? '+' : '') + value.toFixed(1) + '%';
element.textContent = formatted;

if (value > 0) {
element.className = 'metric-change positive';
} else if (value < 0) {
element.className = 'metric-change negative';
} else {
element.className = 'metric-change neutral';
}
}

createCharts() {
this.destroyCharts();
try {
this.createRevenueChart();
this.createBrandSeriesChart();
} catch (error) {
console.error('Chart creation error:', error);
}
}

destroyCharts() {
Object.values(this.charts).forEach(chart => {
if (chart && typeof chart.destroy === 'function') {
chart.destroy();
}
});
this.charts = {};
}

createRevenueChart() {
const ctx = document.getElementById('revenueChart');
if (!ctx) return;

const sortedData = [...this.processedData]
.sort((a, b) => b.orderedRevenue - a.orderedRevenue)
.slice(0, 10);

this.charts.revenue = new Chart(ctx, {
type: 'bar',
data: {
labels: sortedData.map(item => item.title.substring(0, 30) + '...'),
datasets: [{
label: 'Revenue (¬£)',
data: sortedData.map(item => item.orderedRevenue),
backgroundColor: 'rgba(0, 127, 95, 0.8)',
borderColor: '#00FF7F',
borderWidth: 2,
borderRadius: 8,
borderSkipped: false,
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
display: false
}
},
scales: {
y: {
beginAtZero: true,
ticks: {
callback: function(value) {
return '¬£' + value.toLocaleString();
},
color: '#BFC3C9'
},
grid: {
color: 'rgba(0, 127, 95, 0.2)'
}
},
x: {
ticks: {
maxRotation: 45,
color: '#BFC3C9'
},
grid: {
color: 'rgba(0, 127, 95, 0.2)'
}
}
}
}
});
}

// üìö BRAND & SERIES ANALYSIS - The Smart Grouping Feature
createBrandSeriesChart() {
const ctx = document.getElementById('brandSeriesChart');
if (!ctx) return;

const brandSeriesData = this.analyzeBrandsAndSeries().slice(0, 10);

this.charts.brandSeries = new Chart(ctx, {
type: 'doughnut',
data: {
labels: brandSeriesData.map(item => item.name),
datasets: [{
data: brandSeriesData.map(item => item.totalRevenue),
backgroundColor: [
'#007F5F', '#00FF7F', '#005D45', '#40E0D0', '#20B2AA',
'#48D1CC', '#00CED1', '#5F9EA0', '#4682B4', '#6495ED'
],
borderColor: '#1A1A1A',
borderWidth: 2
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
position: 'right',
labels: {
color: '#BFC3C9',
font: { family: 'Inter' }
}
}
}
}
});
}

analyzeBrandsAndSeries() {
const brandGroups = new Map();
const seriesGroups = new Map();

console.log('üß† Starting intelligent brand and series analysis...');

this.processedData.forEach(item => {
const title = item.title.toLowerCase();
const brand = item.brand || 'Unknown Publisher';

// Group by brand/publisher
if (!brandGroups.has(brand)) {
brandGroups.set(brand, {
name: brand,
products: [],
totalRevenue: 0,
totalUnits: 0,
type: 'Brand'
});
}
const brandGroup = brandGroups.get(brand);
brandGroup.products.push(item);
brandGroup.totalRevenue += item.orderedRevenue;
brandGroup.totalUnits += item.orderedUnits;

// üéØ SMART SERIES DETECTION PATTERNS - EXPANDED
const seriesPatterns = [
// üó∫Ô∏è Maps Collections
{ pattern: /ordnance survey|os map|os explorer|os landranger/i, group: 'Ordnance Survey Maps' },
{ pattern: /street map|road map|tourist map/i, group: 'Street & Road Maps' },

// ‚úàÔ∏è Travel Guides
{ pattern: /lonely planet/i, group: 'Lonely Planet Guides' },
{ pattern: /rough guide/i, group: 'Rough Guides Collection' },
{ pattern: /dk eyewitness|eyewitness travel/i, group: 'DK Eyewitness Guides' },
{ pattern: /fodor|fodors/i, group: 'Fodor\'s Travel Guides' },
{ pattern: /frommer/i, group: 'Frommer\'s Guides' },
{ pattern: /rick steves/i, group: 'Rick Steves Guides' },
{ pattern: /time out/i, group: 'Time Out Guides' },

// üìö Educational Series
{ pattern: /gcse.*?(english|maths|science|history|geography|physics|chemistry|biology)/i, group: 'GCSE Study Collection' },
{ pattern: /a-level.*?(english|maths|science|history|geography|physics|chemistry|biology)/i, group: 'A-Level Study Collection' },
{ pattern: /(english|maths|science|history|geography|physics|chemistry|biology).*?gcse/i, group: 'GCSE Study Collection' },
{ pattern: /(english|maths|science|history|geography|physics|chemistry|biology).*?a-level/i, group: 'A-Level Study Collection' },
{ pattern: /ks1|ks2|ks3|key stage/i, group: 'Key Stage Education' },
{ pattern: /revision guide|study guide|exam practice/i, group: 'Study & Revision Guides' },

// üìñ Popular Fiction Series
{ pattern: /harry potter/i, group: 'Harry Potter Series' },
{ pattern: /game of thrones|song of ice and fire/i, group: 'Game of Thrones Series' },
{ pattern: /lord of the rings|hobbit|tolkien/i, group: 'Tolkien Collection' },
{ pattern: /hunger games/i, group: 'Hunger Games Series' },
{ pattern: /twilight saga/i, group: 'Twilight Series' },
{ pattern: /fifty shades|fifty shades of grey/i, group: 'Fifty Shades Series' },
{ pattern: /divergent/i, group: 'Divergent Series' },
{ pattern: /maze runner/i, group: 'Maze Runner Series' },
{ pattern: /diary of a wimpy kid/i, group: 'Diary of a Wimpy Kid' },
{ pattern: /percy jackson/i, group: 'Percy Jackson Series' },

// üë®‚Äçüç≥ Celebrity Chef Collections
{ pattern: /jamie oliver/i, group: 'Jamie Oliver Cookbooks' },
{ pattern: /gordon ramsay/i, group: 'Gordon Ramsay Collection' },
{ pattern: /delia smith/i, group: 'Delia Smith Cookbooks' },
{ pattern: /nigella lawson/i, group: 'Nigella Lawson Collection' },
{ pattern: /mary berry/i, group: 'Mary Berry Collection' },
{ pattern: /jamie olver|thirty minute meals|15 minute meals/i, group: 'Jamie Oliver Cookbooks' },

// üé® Children's Collections
{ pattern: /gruffalo/i, group: 'Gruffalo Collection' },
{ pattern: /peppa pig/i, group: 'Peppa Pig Books' },
{ pattern: /thomas the tank|thomas & friends/i, group: 'Thomas the Tank Engine' },
{ pattern: /roald dahl/i, group: 'Roald Dahl Collection' },
{ pattern: /julia donaldson/i, group: 'Julia Donaldson Books' },
{ pattern: /ladybird books|ladybird classics/i, group: 'Ladybird Books' },
{ pattern: /usborne/i, group: 'Usborne Books' },

// üìÖ Time-Based Collections
{ pattern: /\d{4} edition|\d{4} annual|yearbook \d{4}/i, group: 'Annual Editions' },
{ pattern: /calendar \d{4}|\d{4} calendar/i, group: 'Calendar Collection' },
{ pattern: /diary \d{4}|\d{4} diary/i, group: 'Diary Collection' },
{ pattern: /planner \d{4}|\d{4} planner/i, group: 'Planner Collection' },

// üìö Multi-Volume Series
{ pattern: /volume \d+|vol\. \d+|book \d+|part \d+/i, group: 'Multi-Volume Collection' },
{ pattern: /series \d+|season \d+/i, group: 'Series Collection' },
{ pattern: /complete works|collected works/i, group: 'Complete Works Collection' },

// üé® Art & Design Collections
{ pattern: /art history|history of art/i, group: 'Art History Collection' },
{ pattern: /design principles|graphic design/i, group: 'Design Collection' },
{ pattern: /photography|photographer/i, group: 'Photography Collection' },

// üèÉ‚Äç‚ôÇÔ∏è Health & Fitness Collections
{ pattern: /yoga|pilates|meditation/i, group: 'Wellness Collection' },
{ pattern: /fitness|workout|exercise/i, group: 'Fitness Collection' },
{ pattern: /diet|nutrition|healthy eating/i, group: 'Diet & Nutrition' },

// üíº Business Collections
{ pattern: /business strategy|management|leadership/i, group: 'Business Strategy Collection' },
{ pattern: /marketing|sales|advertising/i, group: 'Marketing Collection' },
{ pattern: /finance|accounting|investment/i, group: 'Finance Collection' },

// üè† Lifestyle Collections
{ pattern: /home improvement|diy|home decoration/i, group: 'Home Improvement Collection' },
{ pattern: /gardening|garden design|plants/i, group: 'Gardening Collection' },
{ pattern: /crafts|crafting|handmade/i, group: 'Crafts Collection' },

// üéµ Music Collections
{ pattern: /piano|guitar|violin|music theory/i, group: 'Music Education' },
{ pattern: /songbook|sheet music/i, group: 'Sheet Music Collection' },

// üåç Language Learning
{ pattern: /learn (french|spanish|german|italian|chinese|japanese|portuguese)/i, group: 'Language Learning' },
{ pattern: /(french|spanish|german|italian|chinese|japanese|portuguese) language/i, group: 'Language Learning' },

// üî¨ Science Collections
{ pattern: /science experiments|lab manual/i, group: 'Science Education' },
{ pattern: /physics|chemistry|biology textbook/i, group: 'Science Textbooks' },

// üèõÔ∏è History Collections
{ pattern: /world war|wwii|ww2|world war ii/i, group: 'World War History' },
{ pattern: /ancient history|roman|greek|egypt/i, group: 'Ancient History' },
{ pattern: /british history|english history/i, group: 'British History' }
];

// Check for series patterns
for (const pattern of seriesPatterns) {
if (pattern.pattern.test(title)) {
if (!seriesGroups.has(pattern.group)) {
seriesGroups.set(pattern.group, {
name: pattern.group,
products: [],
totalRevenue: 0,
totalUnits: 0,
type: 'Series'
});
}
const seriesGroup = seriesGroups.get(pattern.group);
seriesGroup.products.push(item);
seriesGroup.totalRevenue += item.orderedRevenue;
seriesGroup.totalUnits += item.orderedUnits;
break; // Only match first pattern
}
}
});

// Combine and filter significant groups
const allGroups = [];

// Add significant brand groups (¬£500+ revenue, 2+ products)
brandGroups.forEach(group => {
if (group.totalRevenue >= 500 && group.products.length > 1) {
allGroups.push({
...group,
displayName: `${group.name} (${group.products.length} titles)`,
avgRevenue: group.totalRevenue / group.products.length
});
}
});

// Add series groups (2+ products)
seriesGroups.forEach(group => {
if (group.products.length > 1) {
allGroups.push({
...group,
displayName: `${group.name} (${group.products.length} titles)`,
avgRevenue: group.totalRevenue / group.products.length
});
}
});

// Sort by total revenue
allGroups.sort((a, b) => b.totalRevenue - a.totalRevenue);

console.log(`‚úÖ Found ${allGroups.length} significant brand/series groupings`);
return allGroups.slice(0, 20); // Top 20 groups
}

populateTable() {
const tbody = document.getElementById('performanceTableBody');
if (!tbody) return;

tbody.innerHTML = '';

const sortedData = [...this.processedData]
.sort((a, b) => b.orderedRevenue - a.orderedRevenue)
.slice(0, 50);

sortedData.forEach(item => {
const row = tbody.insertRow();

const dailySalesUnits = item.orderedUnits / this.daysInPeriod;
const stockDays = dailySalesUnits > 0 ? item.sellableUnits / dailySalesUnits : null;
const riskDays = stockDays !== null ? stockDays - item.leadTime : null;

let stockDisplay = 'N/A';
let stockColor = '#BFC3C9';

if (stockDays !== null) {
stockDisplay = stockDays.toFixed(0) + ' days';

if (riskDays <= 0) {
stockColor = '#FF6B6B';
} else if (riskDays <= 7) {
stockColor = '#FFA500';
} else if (riskDays <= 14) {
stockColor = '#FFD700';
} else {
stockColor = '#90EE90';
}
}

row.innerHTML = `
<td>${item.asin}</td>
<td>${item.title}</td>
<td>${item.orderedUnits.toLocaleString()}</td>
<td>¬£${item.orderedRevenue.toLocaleString()}</td>
<td>${item.pageViews.toLocaleString()}</td>
<td>${item.conversionRate.toFixed(2)}%</td>
<td>¬£${item.dailySales.toFixed(0)}</td>
<td>${item.leadTime.toFixed(0)}</td>
<td>${item.aged90Percent.toFixed(1)}%</td>
<td style="color: ${stockColor}; font-weight: bold;">${stockDisplay}</td>
<td>${item.netPPM.toFixed(1)}%</td>
`;
});
}

populateInsights() {
this.populateTopConverting();
this.populateRevenueRecovery();
this.populateBrandSeriesInsights();
}

populateTopConverting() {
const totalUnits = this.processedData.reduce((sum, item) => sum + item.orderedUnits, 0);
const adaptiveThreshold = this.calculateAdaptiveThreshold(totalUnits);
const avgConversion = this.processedData.reduce((sum, item) => sum + item.conversionRate, 0) / this.processedData.length;
const conversionThreshold = avgConversion * 1.15;

const topConverting = this.processedData
.filter(item =>
item.conversionRate > conversionThreshold &&
item.conversionRate < 25 &&
item.orderedUnits >= adaptiveThreshold &&
item.pageViews > 0
)
.sort((a, b) => b.conversionRate - a.conversionRate)
.slice(0, 20);

const list = document.getElementById('topConvertingList');
if (list) {
list.innerHTML = '';

const explanation = document.createElement('li');
explanation.style.fontStyle = 'italic';
explanation.style.color = '#666';
explanation.textContent = `Showing products with ${adaptiveThreshold.toFixed(0)}+ units (${((adaptiveThreshold/totalUnits)*100).toFixed(2)}% of portfolio) for marketing scale`;
list.appendChild(explanation);

topConverting.forEach(item => {
const li = document.createElement('li');
const unitsPercent = ((item.orderedUnits / totalUnits) * 100).toFixed(2);
li.textContent = `${item.title} - ${item.conversionRate.toFixed(2)}% CVR (${item.orderedUnits.toLocaleString()} units, ${unitsPercent}% of portfolio)`;
list.appendChild(li);
});

if (topConverting.length === 0) {
const li = document.createElement('li');
li.textContent = `No products meet criteria (>avg CVR, <25%, ${adaptiveThreshold.toFixed(0)}+ units for marketing scale)`;
list.appendChild(li);
}
}
}

calculateAdaptiveThreshold(totalUnits) {
if (totalUnits > 50000) {
return Math.max(totalUnits * 0.001, 50);
} else if (totalUnits > 10000) {
return Math.max(totalUnits * 0.005, 25);
} else if (totalUnits > 1000) {
return Math.max(totalUnits * 0.01, 10);
} else {
return Math.max(totalUnits * 0.02, 5);
}
}

populateRevenueRecovery() {
const avgConversion = this.processedData.reduce((sum, item) => sum + item.conversionRate, 0) / this.processedData.length;
const totalRevenue = this.processedData.reduce((sum, item) => sum + item.orderedRevenue, 0);

let recoveryOpportunities = this.processedData
.filter(item =>
item.orderedRevenue >= 1000 &&
item.pageViews > 0
)
.map(item => {
const conversionGap = Math.max(0, avgConversion - item.conversionRate);
const conversionGapNormalized = conversionGap / avgConversion;
const revenueImpact = (item.orderedRevenue / totalRevenue) * 100;
const agedInventoryScore = item.aged90Percent / 100;

const dailySalesUnits = item.orderedUnits / this.daysInPeriod;
const stockDays = dailySalesUnits > 0 ? item.sellableUnits / dailySalesUnits : null;
const riskDays = stockDays !== null ? stockDays - item.leadTime : null;
const stockRisk = riskDays !== null ? (
riskDays <= 0 ? 'CRITICAL' :
riskDays <= 7 ? 'HIGH' :
riskDays <= 14 ? 'MEDIUM' : 'LOW'
) : 'UNKNOWN';

const matrixScore = (conversionGapNormalized * revenueImpact) + (agedInventoryScore * revenueImpact);

return {
...item,
conversionGap,
revenueImpact,
agedInventoryScore,
matrixScore,
stockDays,
riskDays,
stockRisk
};
})
.sort((a, b) => b.matrixScore - a.matrixScore)
.slice(0, 15);

if (recoveryOpportunities.length < 3) {
recoveryOpportunities = this.processedData
.filter(item =>
item.orderedRevenue >= 500 &&
item.conversionRate < avgConversion
)
.sort((a, b) => b.orderedRevenue - a.orderedRevenue)
.slice(0, 10)
.map(item => ({
...item,
matrixScore: (item.orderedRevenue / totalRevenue) * 100,
revenueImpact: (item.orderedRevenue / totalRevenue) * 100,
stockRisk: 'UNKNOWN'
}));
}

const list = document.getElementById('revenueRecoveryList');
if (list) {
list.innerHTML = '';

const explanation = document.createElement('li');
explanation.style.fontStyle = 'italic';
explanation.style.color = '#666';
explanation.textContent = 'Matrix scoring: High-revenue products with conversion gaps and/or aged inventory';
list.appendChild(explanation);

recoveryOpportunities.forEach(item => {
const li = document.createElement('li');

const stockInfo = item.stockDays !== null ?
`${item.stockDays.toFixed(0)} days stock` :
'Stock data unavailable';

const riskColor = {
'CRITICAL': '#FF6B6B',
'HIGH': '#FFA500',
'MEDIUM': '#FFD700',
'LOW': '#90EE90',
'UNKNOWN': '#BFC3C9'
}[item.stockRisk];

li.innerHTML = `<strong>${item.title}</strong><br>
¬£${item.orderedRevenue.toLocaleString()} (${item.revenueImpact.toFixed(1)}% of portfolio) |
${item.conversionRate.toFixed(2)}% CVR |
<span style="color: #e74c3c; font-weight: bold;">${item.aged90Percent.toFixed(1)}% aged</span> |
<span style="color: ${riskColor}; font-weight: bold;">${stockInfo}</span>`;
list.appendChild(li);
});

if (recoveryOpportunities.length === 0) {
const li = document.createElement('li');
li.textContent = 'No high-impact revenue recovery opportunities identified';
list.appendChild(li);
}
}
}

populateBrandSeriesInsights() {
const brandSeriesData = this.analyzeBrandsAndSeries();
const list = document.getElementById('brandSeriesList');

if (!list) return;

list.innerHTML = '';

if (brandSeriesData.length === 0) {
const li = document.createElement('li');
li.textContent = 'No significant brand or series groupings identified';
list.appendChild(li);
return;
}

brandSeriesData.slice(0, 15).forEach(group => {
const li = document.createElement('li');
li.innerHTML = `<strong>${group.displayName}</strong><br>
Total Revenue: ¬£${group.totalRevenue.toLocaleString()} |
Average: ¬£${group.avgRevenue.toFixed(0)} |
Units: ${group.totalUnits.toLocaleString()}`;
list.appendChild(li);
});
}

exportExcel() {
try {
// Main data sheet
const mainData = this.processedData.map(item => {
const dailySalesUnits = item.orderedUnits / this.daysInPeriod;
const stockDays = dailySalesUnits > 0 ? item.sellableUnits / dailySalesUnits : null;
const riskDays = stockDays !== null ? stockDays - item.leadTime : null;
const stockRisk = riskDays !== null ? (
riskDays <= 0 ? 'CRITICAL' :
riskDays <= 7 ? 'HIGH' :
riskDays <= 14 ? 'MEDIUM' : 'LOW'
) : 'UNKNOWN';

return {
'ASIN': item.asin,
'Product Title': item.title,
'Brand': item.brand,
'Ordered Units': item.orderedUnits,
'Ordered Revenue': item.orderedRevenue,
'Page Views': item.pageViews,
'Conversion Rate %': item.conversionRate.toFixed(2),
'Daily Sales': item.dailySales.toFixed(2),
'Net PPM %': item.netPPM.toFixed(2),
'Lead Time Days': item.leadTime.toFixed(0),
'90+ Days Inventory %': item.aged90Percent.toFixed(1),
'Days of Stock': stockDays !== null ? stockDays.toFixed(0) : 'N/A',
'Stock Risk Level': stockRisk,
'Ordered Revenue YoY %': item.orderedRevenueYoY ? item.orderedRevenueYoY.toFixed(1) : 'N/A',
'Ordered Units YoY %': item.orderedUnitsYoY ? item.orderedUnitsYoY.toFixed(1) : 'N/A'
};
});

// Brand/Series insights sheet
const brandSeriesData = this.analyzeBrandsAndSeries().map(group => ({
'Group Name': group.name,
'Type': group.type,
'Total Revenue': group.totalRevenue,
'Total Units': group.totalUnits,
'Average Revenue': group.avgRevenue.toFixed(2),
'Product Count': group.products.length
}));

const wb = XLSX.utils.book_new();

// Add main data sheet
const ws1 = XLSX.utils.json_to_sheet(mainData);
XLSX.utils.book_append_sheet(wb, ws1, 'Product Performance');

// Add brand/series insights sheet
const ws2 = XLSX.utils.json_to_sheet(brandSeriesData);
XLSX.utils.book_append_sheet(wb, ws2, 'Brand & Series Analysis');

const fileName = 'zon_analytics_report_' + new Date().toISOString().split('T')[0] + '.xlsx';
XLSX.writeFile(wb, fileName);

this.showSuccess('Excel report exported successfully!');
} catch (error) {
console.error('Export error:', error);
this.showError('Export failed: ' + error.message);
}
}

exportCSV() {
try {
const csvData = this.processedData.map(item => {
const dailySalesUnits = item.orderedUnits / this.daysInPeriod;
const stockDays = dailySalesUnits > 0 ? item.sellableUnits / dailySalesUnits : null;
const riskDays = stockDays !== null ? stockDays - item.leadTime : null;
const stockRisk = riskDays !== null ? (
riskDays <= 0 ? 'CRITICAL' :
riskDays <= 7 ? 'HIGH' :
riskDays <= 14 ? 'MEDIUM' : 'LOW'
) : 'UNKNOWN';

return {
'ASIN': item.asin,
'Product Title': item.title,
'Brand': item.brand,
'Ordered Units': item.orderedUnits,
'Ordered Revenue': item.orderedRevenue,
'Page Views': item.pageViews,
'Conversion Rate %': item.conversionRate.toFixed(2),
'Daily Sales': item.dailySales.toFixed(2),
'Net PPM %': item.netPPM.toFixed(2),
'Lead Time Days': item.leadTime.toFixed(0),
'90+ Days Inventory %': item.aged90Percent.toFixed(1),
'Days of Stock': stockDays !== null ? stockDays.toFixed(0) : 'N/A',
'Stock Risk Level': stockRisk,
'Ordered Revenue YoY %': item.orderedRevenueYoY ? item.orderedRevenueYoY.toFixed(1) : 'N/A',
'Ordered Units YoY %': item.orderedUnitsYoY ? item.orderedUnitsYoY.toFixed(1) : 'N/A'
};
});

const csv = Papa.unparse(csvData);
const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
const link = document.createElement('a');
const url = URL.createObjectURL(blob);
link.setAttribute('href', url);
link.setAttribute('download', 'zon_analytics_report_' + new Date().toISOString().split('T')[0] + '.csv');
link.style.visibility = 'hidden';
document.body.appendChild(link);
link.click();
document.body.removeChild(link);

this.showSuccess('CSV report exported successfully!');
} catch (error) {
console.error('Export error:', error);
this.showError('Export failed: ' + error.message);
}
}
}

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
new VendorDashboard();
});
</script>
</body>
</html>
